<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
	<meta name="author" content="">
	
	<title>Cart</title>

    <!-- Bootstrap core CSS -->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="css/cart.css" rel="stylesheet">

    <!-- Bootstrap core JavaScript -->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

	

</head>

<!-- 判斷登入狀態 -->
<% if (userid == undefined){ %>
<body onload="alert_login()">
<% } else { %>
<body onload="loadCart()" 
<% } %>

    <!-- Navigation -->
    <%- include('header.html') -%>

	<div class="container" style="margin-top: 80px;">
		<table class="table" >
			<thead class="thead-light">
				<tr>
					<th scope="col" >Name</th>
					<th scope="col" >Price</th>
					<th scope="col" >Amount</th>
					<th scope="col" ></th>
				</tr>
			</thead>

			<tbody id='body'>
				<% for(var i=0; i < c_data.length; i++){ %>
					<tr id="<%= c_data[i].name %>">
						<th scope="row"><%= c_data[i].name %></th>
						<td><h6><strong><%= c_data[i].price %></strong></h6></td>
						<td><input type="number" id="amount" class="<%= c_data[i].name %>" value="<%= c_data[i].amount %>"></td>
						<td>
							<a href="#"><input type="button" class="<%= c_data[i].name %>" value="刪除"></a>
						</td>
					</tr>
				<% } %>

			</tbody>

			<tfoot>
				<tr>
					<th scope="row"></th>
					<td><h5 class="text-right" style="font-size:1rem;">Total:<a></td>
					<td>
						<strong id='total'>0</strong>
					</td>
					<td>
						<button onclick="clearCart()">結帳</button>
					</td>
				</tr>
			</tfoot>
		</table>
		<a href="/">繼續購物</a>
	</div>



		<script>

			function loadCart(){
				Count()
				amountChange()
			}

			// 偵測修改數量事件，和刪除商品事件
			function amountChange() {	

				const am = document.querySelectorAll("input[type = 'number']").forEach(item =>{
					item.addEventListener('change', event =>{
						console.log(item.className)
						console.log("amount", event.target.value)
						Count()

						// 用 AJAX 傳回變動後的產品數量給 Server
						let p_data = JSON.stringify({"name": item.className, "amount": event.target.value})
						var r = new XMLHttpRequest();
						r.open("POST", "updateProductAmount", true);
						r.onreadystatechange = function () {
							if (r.readyState != 4 || r.status != 200) return;
						};
						r.send(p_data);						
					})
				})

				// 偵測刪除商品事件
				const rm = document.querySelectorAll("input[type = 'button']").forEach(item =>{
					item.addEventListener('click', event =>{						
						// 用 AJAX 傳回要刪除的商品給 Server
						let p_data = JSON.stringify({"name": item.className})
						var r = new XMLHttpRequest();
						r.open("POST", "removeCartItem", true);
						r.onreadystatechange = function () {
							if (r.readyState != 4 || r.status != 200) return;
						};
						r.send(p_data);

						// 清除該列內容的動態效果
						console.log("removeCartItem",item.className)
						document.getElementById(item.className).innerHTML = '' 
						console.log("rm test")
						Count()
					})
				})
			}

			// 計算總金額
			function Count() {
				let sum = 0
				let price = document.querySelectorAll("h6 > strong")
				let amount = document.querySelectorAll("input[type = number]")
		
				for (i = 0; i < price.length; i++) {
					p = Number(price[i].innerHTML)
					a = Number(amount[i].value)
					sum += p * a
				}
				document.querySelector("#total").innerHTML = sum;
			}

			// 清除購物車
			function clearCart() {
				localStorage.clear()
				location.href = '/'
			}

			// 登入提醒視窗
			function alert_login() {
				alert('請先登入')
				location.href = '/'
			}
			
		</script>
	</body>
</html>