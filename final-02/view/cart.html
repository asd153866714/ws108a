<html>

<head>

	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css"
		integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
	<link rel="stylesheet" href="css/cart.css">
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js"
		integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k"
		crossorigin="anonymous"></script>

	<title>Cart</title>

</head>

<!-- 判斷登入狀態 -->
<% if (userid == undefined){ %>
<body onload="alert_login()">
<% } else { %>
<body onload="loadCart()" 
<% } %>

	<input type="hidden" value="<%= c_data %>" id="data">

	<div class="container" style="margin-top: 30px;">
		<table class="table" style=" text-align: center;">
			<thead class="thead-light">
				<tr>
					<th scope="col" style="width: 5%;">#</th>
					<th scope="col" style="width: 20%;">Name</th>
					<th scope="col" style="width: 25%;">Price</th>
					<th scope="col" style="width: 25%;">Amount</th>
					<th scope="col" style="width: 25%;"></th>
				</tr>
			</thead>

			<tbody id='body'>
				<% for(var i=0; i < c_data.length; i++){ %>
					<tr id="<%= c_data[i].name %>">
						<th scope="row"><%= i %></th>
						<td><%= c_data[i].name %></td>
						<td><h6><strong><%= c_data[i].price %></strong></h6></td>
						<td><input type="number" class="<%= c_data[i].name %>" value="<%= c_data[i].amount %>"></td>
						<td>
							<a href="#"><input type="button" class="<%= c_data[i].name %>" value="刪除"></a>
						</td>
					</tr>
				<% } %>

			</tbody>

			<tfoot>
				<tr>
					<th scope="row"></th>
					<td></td>
					<td><h5 class="text-right" style="font-size:1rem;">總金額 :<a></td>
					<td>
						<strong id='total'>0</strong>
					</td>
					<td>
						<button onclick="clearCart()">結帳</button>
					</td>
				</tr>
			</tfoot>
		</table>
		<a href="/">繼續購物</a>
	</div>



		<script>

			function loadCart(){
				Count()
				amountChange()
			}

			// 偵測修改數量事件，和刪除商品事件
			function amountChange() {	

				const am = document.querySelectorAll("input[type = 'number']").forEach(item =>{
					item.addEventListener('change', event =>{
						console.log(item.className)
						console.log("amount", event.target.value)
						Count()

						// 用 AJAX 傳回變動後的產品數量給 Server
						let p_data = JSON.stringify({"name": item.className, "amount": event.target.value})
						var r = new XMLHttpRequest();
						r.open("POST", "updateProductAmount", true);
						r.onreadystatechange = function () {
							if (r.readyState != 4 || r.status != 200) return;
						};
						r.send(p_data);						
					})
				})

				// 偵測刪除商品事件
				const rm = document.querySelectorAll("input[type = 'button']").forEach(item =>{
					item.addEventListener('click', event =>{						
						// 用 AJAX 傳回要刪除的商品給 Server
						let p_data = JSON.stringify({"name": item.className})
						var r = new XMLHttpRequest();
						r.open("POST", "removeCartItem", true);
						r.onreadystatechange = function () {
							if (r.readyState != 4 || r.status != 200) return;
						};
						r.send(p_data);

						// 清除該列內容的動態效果
						console.log("removeCartItem",item.className)
						document.getElementById(item.className).innerHTML = '' 
						console.log("rm test")
						Count()
					})
				})
			}

			// 計算總金額
			function Count() {
				let sum = 0
				let price = document.querySelectorAll("h6 > strong")
				let amount = document.querySelectorAll("input[type = number]")
		
				for (i = 0; i < price.length; i++) {
					p = Number(price[i].innerHTML)
					a = Number(amount[i].value)
					sum += p * a
				}
				document.querySelector("#total").innerHTML = sum;
			}

			// 清除購物車
			function clearCart() {
				localStorage.clear()
				location.href = '/'
			}

			// 登入提醒視窗
			function alert_login() {
				alert('請先登入')
				location.href = '/'
			}
			
		</script>
	</body>
</html>